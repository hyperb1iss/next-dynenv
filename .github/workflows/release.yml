name: ðŸš€ Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

env:
  NODE_VERSION: '22'

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ðŸš€ Release & Publish
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  release:
    name: ðŸš€ Release & Publish
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      released: ${{ steps.semantic.outputs.new_release_published }}
      version: ${{ steps.semantic.outputs.new_release_version }}
      channel: ${{ steps.semantic.outputs.new_release_channel }}

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: ðŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build package
        run: pnpm build

      - name: ðŸ” Verify package contents
        run: |
          echo "### ðŸ“¦ Package Contents" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lah build/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: ðŸš€ Semantic Release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          GIT_AUTHOR_NAME: 'github-actions[bot]'
          GIT_AUTHOR_EMAIL: 'github-actions[bot]@users.noreply.github.com'
          GIT_COMMITTER_NAME: 'github-actions[bot]'
          GIT_COMMITTER_EMAIL: 'github-actions[bot]@users.noreply.github.com'
        run: pnpm semantic-release

      - name: ðŸ“Š Release Summary
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          echo "### ðŸŽ‰ Release Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.semantic.outputs.new_release_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Channel:** \`${{ steps.semantic.outputs.new_release_channel }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Git Tag:** \`${{ steps.semantic.outputs.new_release_git_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ [View on npm](https://www.npmjs.com/package/next-dynenv/v/${{ steps.semantic.outputs.new_release_version }})" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ [View Release Notes](https://github.com/${{ github.repository }}/releases/tag/${{ steps.semantic.outputs.new_release_git_tag }})" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“­ No Release
        if: steps.semantic.outputs.new_release_published != 'true'
        run: |
          echo "### â„¹ï¸ No Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No releaseable changes detected in this commit." >> $GITHUB_STEP_SUMMARY

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ðŸ”€ Back-merge (main â†’ development)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  back-merge:
    name: ðŸ”€ Back-merge
    runs-on: ubuntu-latest
    needs: release
    if: github.ref == 'refs/heads/main' && needs.release.outputs.released == 'true'
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸ”€ Merge main into development
        run: |
          git fetch origin main development
          git checkout development
          git pull origin development

          # Try merge with auto-commit
          if git merge origin/main --no-ff -m "ci: ðŸ”€ back-merge main into development [skip ci]"; then
            git push origin development
            echo "### âœ… Back-merge Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Successfully merged main into development" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Merge Conflict Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Automatic back-merge failed due to conflicts." >> $GITHUB_STEP_SUMMARY
            echo "Please manually merge main into development." >> $GITHUB_STEP_SUMMARY
            git merge --abort
            exit 1
          fi

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ðŸ“¢ Notification
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  notify:
    name: ðŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [release, back-merge]
    if: always() && needs.release.outputs.released == 'true'

    steps:
      - name: ðŸ“¢ Success Notification
        if: needs.back-merge.result == 'success' || needs.back-merge.result == 'skipped'
        run: |
          echo "### ðŸŽ‰ Release Pipeline Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Package published to npm" >> $GITHUB_STEP_SUMMARY
          echo "âœ… GitHub release created" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.back-merge.result }}" == "success" ]; then
            echo "âœ… Development branch updated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: âš ï¸ Partial Success
        if: needs.back-merge.result == 'failure'
        run: |
          echo "### âš ï¸ Release Published with Warnings" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Package published to npm" >> $GITHUB_STEP_SUMMARY
          echo "âœ… GitHub release created" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Back-merge failed - manual intervention required" >> $GITHUB_STEP_SUMMARY
